name: Build LaTeX document
on: 
  workflow_call:
    inputs:
      texfile:
        description: The main LaTeX file to compile
        type: string
        required: true
      bibfile:
        description: The main BibTeX file to compile
        type: string
        required: true

env:
  OUTPUT_DIR: 'github_artifacts'

jobs:
  build_latex:
    runs-on: ubuntu-latest
    steps:
    - name: Setup repository
      uses: actions/checkout@v2
    - name: List files
      run: ls -R
    - name: Install LaTeX's dependencies
      run: sudo apt-get update && sudo apt-get install texlive texlive-xetex texlive-publishers texlive-science texlive-bibtex-extra biber latexmk cm-super
    - name: First compliation
      continue-on-error: true
      run: xelatex ${{ github.event.inputs.texfile }}.tex; bibtex ${{ github.event.inputs.bibfile }}.bib;
      # run: latexmk -xelatex -bibtex ${{ env.TEXFILE }}
      # run: pdflatex ${{ env.TEXFILE }}; bibtex ${{ env.TEXFILE }}; pdflatex ${{ env.TEXFILE }}; pdflatex ${{ env.TEXFILE }};
    - name: Second compliation
      continue-on-error: true
      run: xelatex ${{ github.event.inputs.texfile }}.tex; xelatex ${{ github.event.inputs.texfile }}.tex;
      # run: latexmk -xelatex -bibtex ${{ env.TEXFILE }}
      # run: pdflatex ${{ env.TEXFILE }}; bibtex ${{ env.TEXFILE }}; pdflatex ${{ env.TEXFILE }}; pdflatex ${{ env.TEXFILE }};
    - name: List files
      run: ls -R
    - name: Move pdf to artifacts
      run: mkdir -p ${{ env.OUTPUT_DIR }} && mv ${{ github.event.inputs.texfile }}.pdf ${{ env.OUTPUT_DIR }}/${{ github.event.inputs.texfile }}.pdf
    - name: List files
      run: ls -R
    - name: Upload pdf as artifact
      uses: actions/upload-artifact@v2
      with:
        name: ${{ env.TEXFILE }}.pdf
        path: ./${{ env.OUTPUT_DIR }}
